<?xml version="1.0" encoding="utf-8" ?>
<?xml-model href="../../../../build/vendor/wix/doc/wix.xsd"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product
    Id="*"
    Name="Koishi"
    Manufacturer="Il Harper"
    UpgradeCode="02318298-8D9E-4C30-B963-BB0B16F1F126"
    Language="1033"
    Codepage="1252"
    Version="{{koiSemver.major}}.{{koiSemver.minor}}.{{koiSemver.patch}}"
  >
    <Package
      Id="*"
      Compressed="yes"
      Keywords="Installer"
      InstallerVersion="500"
      InstallPrivileges="elevated"
      Platform="x64"
      Description="Koishi Installer"
      Comments="Koishi {{koiVersion}} Installer"
      Manufacturer="Il Harper"
      Languages="1033"
      SummaryCodepage="1252"
    />

    <Icon Id="Icon.exe" SourceFile="{{{iconPath}}}" />
    <Property Id="ARPPRODUCTICON" Value="Icon.exe" />
    <Property Id="ARPHELPLINK" Value="https://koishi.chat" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
    <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />

    <Condition
      Message="Koishi only runs on Windows 8.1 or higher."
    >VersionNT >= 603</Condition>
    <Condition
      Message="You need to install Koishi on 64-bit Windows."
    >VersionNT64</Condition>

    <MajorUpgrade
      AllowSameVersionUpgrades="yes"
      DowngradeErrorMessage="A newer version of Koishi is already installed."
    />

    <Media Id="1" Cabinet="media.cab" EmbedCab="yes" />
    <Property Id="DiskPrompt" Value="Koishi {{koiVersion}} Installer" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="DIRECTORYINSTALL" Name="Koishi">
          <Component
            Id="ComponentDirectoryInstall"
            Guid="7D40E7CF-C007-47C9-A6F9-75E7BFF355C8"
            Win64="yes"
          >
            <CreateFolder />
            <RemoveFolder Id="RemoveDirectoryInstall" On="uninstall" />
          </Component>
          <Component Id="ComponentFileKoi" Guid="*" Win64="yes">
            <File Id="FileKoi" KeyPath="yes" Source="SourceDir\koi.exe" />
          </Component>
          <Component Id="ComponentFileUnfold" Guid="*" Win64="yes">
            <File Id="FileUnfold" KeyPath="yes" Source="SourceDir\unfold.exe" />
          </Component>
          <Component Id="ComponentFileWebViewLoader" Guid="*" Win64="yes">
            <File
              Id="FileWebViewLoader"
              KeyPath="yes"
              Source="SourceDir\WebView2Loader.dll"
            />
          </Component>
        </Directory>
      </Directory>

      <Directory Id="ProgramMenuFolder">
        <Directory Id="DirectoryProgramMenuFolder" Name="Koishi">
          <Component
            Id="ComponentDirectoryProgramMenuFolder"
            Guid="4D488340-00D4-4D15-A3EA-1F4C38CB3963"
            Win64="yes"
          >
            <CreateFolder />
            <RemoveFolder
              Id="RemoveDirectoryProgramMenuFolder"
              On="uninstall"
            />
            <Shortcut
              Id="ShortcutDirectoryProgramMenuFolderKoishi"
              Name="Koishi"
              Description="Start Koishi."
              Target="[DIRECTORYINSTALL]koi.exe"
              WorkingDirectory="DIRECTORYINSTALL"
            />
            <Shortcut
              Id="ShortcutDirectoryProgramMenuFolderUninstallKoishi"
              Name="Uninstall Koishi"
              Target="[SystemFolder]msiexec.exe"
              Arguments="/x [ProductCode]"
              Description="Uninstalls Koishi."
            />
            <RegistryValue
              Root="HKCU"
              Key="Software\Il Harper\Koishi"
              Type="string"
              Value=""
              KeyPath="yes"
            />
          </Component>
        </Directory>
      </Directory>

      <Directory Id="DesktopFolder">
        <Component
          Id="ComponentDirectoryDesktopFolder"
          Guid="B3988140-7A1A-4240-A0E9-315CCBD5193B"
          Win64="yes"
        >
          <CreateFolder />
          <Shortcut
            Id="ShortcutDirectoryDesktopFolderKoishi"
            Name="Koishi"
            Description="Start Koishi."
            Target="[DIRECTORYINSTALL]koi.exe"
            WorkingDirectory="DIRECTORYINSTALL"
          />
          <RegistryValue
            Root="HKCU"
            Key="Software\Il Harper\Koishi"
            Type="string"
            Value=""
            KeyPath="yes"
          />
        </Component>
      </Directory>
    </Directory>

    <Feature
      Id="Complete"
      Title="Koishi"
      Description="The Koishi app."
      Display="expand"
      Level="1"
      Absent="disallow"
      InstallDefault="local"
      AllowAdvertise="no"
      ConfigurableDirectory="DIRECTORYINSTALL"
    >
      <Feature
        Id="FeatureCore"
        Title="Core"
        Description="Core feature of Koishi."
        Level="1"
        Absent="disallow"
        InstallDefault="local"
        AllowAdvertise="no"
      >
        <ComponentRef Id="ComponentDirectoryInstall" />
        <ComponentRef Id="ComponentFileKoi" />
        <ComponentRef Id="ComponentFileUnfold" />
        <ComponentRef Id="ComponentFileWebViewLoader" />
        <ComponentRef Id="ComponentDirectoryProgramMenuFolder" />
      </Feature>
      <Feature
        Id="FeatureDesktopIcon"
        Title="Desktop Icon"
        Description="Add a shortcut of Koishi on desktop."
        Level="1000"
        InstallDefault="local"
        AllowAdvertise="no"
      >
        <ComponentRef Id="ComponentDirectoryDesktopFolder" />
      </Feature>
    </Feature>

    <Property Id="WIXUI_INSTALLDIR" Value="DIRECTORYINSTALL" />
    <UIRef Id="WixUI_Mondo" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <CustomAction
      Id="CustomActionUnfold"
      FileKey="FileUnfold"
      ExeCommand="ensure"
      Execute="deferred"
      Impersonate="no"
      Return="check"
    />
    <InstallExecuteSequence>
      <Custom
        Action="CustomActionUnfold"
        After="InstallFiles"
      >NOT Installed</Custom>
    </InstallExecuteSequence>
  </Product>
</Wix>
